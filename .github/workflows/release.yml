name: Build and Release

on:
  push:
    tags:
      - 'v*'  # e.g. v1.0.0

jobs:
  release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
          - os: macos-latest
            platform: mac
          - os: ubuntu-latest
            platform: linux

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          # only install the minimal packages needed for native builds
          sudo apt-get install -y build-essential python3 libvips-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Widgit/package-lock.json

      - name: Install dependencies
        working-directory: Widgit
        run: npm ci

      - name: Build app
        working-directory: Widgit
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RealBuddy-${{ matrix.platform }}
          path: Widgit/dist/

  create-release:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          find . -type f ! -name "*.sha256" -exec sha256sum {} + > SHA256SUMS
          cat SHA256SUMS

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets
        shell: bash
        run: |
          set -euo pipefail
          upload_url="${{ steps.create_release.outputs.upload_url }}"
          if [ -z "$upload_url" ]; then
            echo "upload_url output is empty"
            exit 1
          fi
          shopt -s globstar
          for f in artifacts/**; do
            if [ -f "$f" ]; then
              name=$(basename "$f")
              content_type=$(file --brief --mime-type "$f" || echo application/octet-stream)
              echo "Uploading $f as $name (type=$content_type)"
              curl -sS --fail -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: $content_type" \
                --data-binary @"$f" "${upload_url}?name=${name}"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
